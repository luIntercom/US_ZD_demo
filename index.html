<!doctype html>
<html>
  <head>
    <title>Fin ZD demo</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      // Clear storage & cookies, then reload
      function reset() {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i];
          const eqPos = cookie.indexOf("=");
          const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
          document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
        }
        window.localStorage.clear();
        window.sessionStorage.clear();
        window.location.reload();
      }

      // Random user data
      function generateRandomUser() {
        const firstNames = ["Alex","Jamie","Taylor","Jordan","Sam","Casey","Riley","Morgan","Chris","Avery","Quinn","Devon"];
        const lastNames  = ["Smith","Johnson","Brown","Davis","Miller","Wilson","Moore","Taylor","Anderson","Thomas","Lee","Clark"];
        const first = firstNames[Math.floor(Math.random() * firstNames.length)];
        const last  = lastNames[Math.floor(Math.random() * lastNames.length)];
        const name  = `${first} ${last}`;
        const email = `${first}.${last}.${Math.floor(Math.random()*1e6)}@example.com`.toLowerCase();
        const user_id = (Date.now().toString() + Math.floor(Math.random() * 1e6).toString()).slice(0,16);
        return { user_id, name, email };
      }

      // Load Intercom widget script
      function loadIntercom() {
        (function() {
          var w = window;
          var ic = w.Intercom;
          if (typeof ic === "function") {
            ic("reattach_activator");
            ic("update", w.intercomSettings);
          } else {
            var d = document;
            var i = function() { i.c(arguments); };
            i.q = [];
            i.c = function(args) { i.q.push(args); };
            w.Intercom = i;
            var l = function() {
              var s = d.createElement("script");
              s.type = "text/javascript";
              s.async = true;
              s.src = "https://widget.intercom.io/widget/z1n0atmw";
              var x = d.getElementsByTagName("script")[0];
              x.parentNode.insertBefore(s, x);
            };
            if (d.readyState === "complete") { l(); }
            else if (w.attachEvent) { w.attachEvent("onload", l); }
            else { w.addEventListener("load", l, false); }
          }
        })();
      }

      // Initialize: get JWT from webhook, then boot Intercom
      async function init() {
        try {
          const user = generateRandomUser();

          const resp = await fetch("https://luis-intercom.app.n8n.cloud/webhook-test/6f634ad9-cf33-4dfe-b0b5-706a3090cbc7", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              user_id: user.user_id,
              name: user.name,
              email: user.email
            }),
            // credentials omitted intentionally; adjust if your webhook needs them
          });

          if (!resp.ok) {
            throw new Error(`Webhook returned ${resp.status}`);
          }

          const data = await resp.json();
          if (!data || !data.intercom_user_jwt) {
            throw new Error("Webhook response missing intercom_user_jwt");
          }

          // REQUIRED shape:
          window.intercomSettings = {
            api_base: "https://api-iam.intercom.io",
            app_id: "z1n0atmw",
            intercom_user_jwt: data.intercom_user_jwt
          };

          loadIntercom();
        } catch (err) {
          console.error("Failed to initialize Intercom via JWT:", err);
          const status = document.getElementById("status");
          if (status) {
            status.textContent = "Failed to initialize Intercom (see console).";
            status.classList.remove("hidden");
          }
        }
      }

      // Kick off on load
      document.addEventListener("DOMContentLoaded", init);
    </script>
  </head>

  <body class="p-6 flex flex-col flex-1 items-center justify-center min-h-screen bg-cover" style="background-image: url('https://downloads.intercomcdn.com/i/o/1051523575/8c16c6bb97ae791131ead20c/blur.jpg')">
    <div class="flex flex-col space-y-3 items-center">
      <img src="https://static.intercomassets.com/assets/default-avatars/fin/128-6a5eabbb84cc2b038b2afc6698ca0a974faf7adc9ea9f0fb3c3e78ac12543bc5.png" height="50" width="50" alt="Fin avatar" />
      <button class="bg-black text-white px-3 py-2 rounded hover:bg-opacity-75" onclick="reset()">Reset</button>
      <div id="status" class="hidden text-sm text-red-600"></div>
    </div>

    <!-- Zendesk Widget (unchanged) -->
    <script id="ze-snippet" src="https://static.zdassets.com/ekr/snippet.js?key=64e085db-b7a2-4e29-911a-1987b55892bf"></script>
  </body>
</html>
